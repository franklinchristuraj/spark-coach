# Iteration 1: Morning Briefing — End to End

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Deploy Rafiki as a PWA at `coach.ziksaka.com` so the daily briefing is visible on your phone.

**Architecture:** Next.js frontend deployed to Vercel (custom domain `coach.ziksaka.com`), FastAPI backend on VPS behind Nginx at `coach-api.ziksaka.com`. The UI is already fully built — this plan is deployment and PWA plumbing only.

**Tech Stack:** Next.js 14 (App Router), FastAPI, Docker Compose, Nginx, Certbot, Vercel

---

## Context

All 5 screens, auth, API client, and hooks are already built in `mobile/`. No UI work needed.

**Gaps to close:**
- No `mobile/public/` directory → PWA cannot be installed on phone
- CORS allows only `localhost` → production frontend will be blocked
- No `mobile/Dockerfile` or Nginx config → backend not accessible via domain

**Working directories:**
- Frontend commands: run from `mobile/`
- Backend commands: run from `backend/`
- Deploy commands: run from repo root

---

## Task 1: Generate placeholder PWA icons

**Files:**
- Create: `mobile/scripts/generate-icons.py`
- Create: `mobile/public/icon.svg`
- Creates (via script): `mobile/public/icon-192.png`, `mobile/public/icon-512.png`, `mobile/public/icon-light-32x32.png`, `mobile/public/icon-dark-32x32.png`, `mobile/public/apple-icon.png`

**Step 1: Create the icon generation script**

Create `mobile/scripts/generate-icons.py`:

```python
#!/usr/bin/env python3
"""Generate placeholder Rafiki icons using only Python stdlib."""
import os
import struct
import zlib


def make_png(width, height, hex_color):
    """Create a minimal solid-color PNG without external dependencies."""
    r = int(hex_color[1:3], 16)
    g = int(hex_color[3:5], 16)
    b = int(hex_color[5:7], 16)

    # Each row: filter byte (0=None) + RGB pixels
    row = b"\x00" + bytes([r, g, b] * width)
    raw = row * height
    compressed = zlib.compress(raw)

    def chunk(tag: bytes, data: bytes) -> bytes:
        crc = zlib.crc32(tag + data) & 0xFFFFFFFF
        return struct.pack(">I", len(data)) + tag + data + struct.pack(">I", crc)

    png = b"\x89PNG\r\n\x1a\n"
    png += chunk(b"IHDR", struct.pack(">IIBBBBB", width, height, 8, 2, 0, 0, 0))
    png += chunk(b"IDAT", compressed)
    png += chunk(b"IEND", b"")
    return png


ICONS = {
    "public/icon-light-32x32.png": (32, 32, "#2C2C2C"),
    "public/icon-dark-32x32.png": (32, 32, "#FAF8F5"),
    "public/apple-icon.png": (180, 180, "#2C2C2C"),
    "public/icon-192.png": (192, 192, "#2C2C2C"),
    "public/icon-512.png": (512, 512, "#2C2C2C"),
}

os.makedirs("public", exist_ok=True)
for path, (w, h, color) in ICONS.items():
    with open(path, "wb") as f:
        f.write(make_png(w, h, color))
    print(f"Created {path}")
print("Done.")
```

**Step 2: Create the SVG icon**

Create `mobile/public/icon.svg`:

```svg
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
  <rect width="32" height="32" rx="6" fill="#2C2C2C"/>
  <text x="16" y="23" text-anchor="middle" font-family="sans-serif"
        font-weight="700" font-size="20" fill="#FAF8F5">R</text>
</svg>
```

**Step 3: Run the script**

```bash
cd mobile && python3 scripts/generate-icons.py
```

Expected output:
```
Created public/icon-light-32x32.png
Created public/icon-dark-32x32.png
Created public/apple-icon.png
Created public/icon-192.png
Created public/icon-512.png
Done.
```

**Step 4: Verify files exist**

```bash
ls -lh mobile/public/
```

Expected: 6 files (5 PNGs + 1 SVG).

**Step 5: Commit**

```bash
git add mobile/scripts/ mobile/public/
git commit -m "feat(pwa): add placeholder icons for PWA install"
```

---

## Task 2: Add PWA manifest

**Files:**
- Create: `mobile/public/manifest.json`
- Test: verify manifest has required PWA fields

**Step 1: Write the failing test**

Create `mobile/scripts/test-manifest.py`:

```python
#!/usr/bin/env python3
"""Verify manifest.json has required PWA fields."""
import json
import sys

with open("public/manifest.json") as f:
    m = json.load(f)

errors = []
for field in ["name", "short_name", "display", "start_url", "icons", "theme_color", "background_color"]:
    if field not in m:
        errors.append(f"Missing required field: {field}")

if m.get("display") not in ["standalone", "fullscreen", "minimal-ui"]:
    errors.append(f"Invalid display value: {m.get('display')}")

icons = m.get("icons", [])
sizes = {i.get("sizes") for i in icons}
for required_size in ["192x192", "512x512"]:
    if required_size not in sizes:
        errors.append(f"Missing icon size: {required_size}")

if errors:
    for e in errors:
        print(f"FAIL: {e}")
    sys.exit(1)

print("PASS: manifest.json is valid")
```

**Step 2: Run test to verify it fails**

```bash
cd mobile && python3 scripts/test-manifest.py
```

Expected: `FileNotFoundError: [Errno 2] No such file or directory: 'public/manifest.json'`

**Step 3: Create the manifest**

Create `mobile/public/manifest.json`:

```json
{
  "name": "Rafiki",
  "short_name": "Rafiki",
  "description": "Your personal AI learning coach",
  "display": "standalone",
  "orientation": "portrait",
  "start_url": "/",
  "scope": "/",
  "background_color": "#FAF8F5",
  "theme_color": "#FAF8F5",
  "icons": [
    {
      "src": "/icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icon-512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ]
}
```

**Step 4: Run test to verify it passes**

```bash
cd mobile && python3 scripts/test-manifest.py
```

Expected: `PASS: manifest.json is valid`

**Step 5: Commit**

```bash
git add mobile/public/manifest.json mobile/scripts/test-manifest.py
git commit -m "feat(pwa): add PWA manifest for Rafiki"
```

---

## Task 3: Wire manifest into layout.tsx

**Files:**
- Modify: `mobile/app/layout.tsx`

**Step 1: Update the metadata export**

In `mobile/app/layout.tsx`, the `metadata` object currently has `title`, `description`, `generator`, `icons`. Add `manifest` and `appleWebApp` fields:

Find this block (lines 8–29):
```tsx
export const metadata: Metadata = {
  title: 'RAFIKI - Personal AI Coach',
  description: 'Your calm, intelligent AI coaching companion. Socratic mentorship powered by your personal knowledge vault.',
  generator: 'v0.app',
  icons: {
    icon: [
      {
        url: '/icon-light-32x32.png',
        media: '(prefers-color-scheme: light)',
      },
      {
        url: '/icon-dark-32x32.png',
        media: '(prefers-color-scheme: dark)',
      },
      {
        url: '/icon.svg',
        type: 'image/svg+xml',
      },
    ],
    apple: '/apple-icon.png',
  },
}
```

Replace with:
```tsx
export const metadata: Metadata = {
  title: 'Rafiki',
  description: 'Your personal AI learning coach',
  manifest: '/manifest.json',
  appleWebApp: {
    capable: true,
    statusBarStyle: 'default',
    title: 'Rafiki',
  },
  icons: {
    icon: [
      {
        url: '/icon-light-32x32.png',
        media: '(prefers-color-scheme: light)',
      },
      {
        url: '/icon-dark-32x32.png',
        media: '(prefers-color-scheme: dark)',
      },
      {
        url: '/icon.svg',
        type: 'image/svg+xml',
      },
    ],
    apple: '/apple-icon.png',
  },
}
```

**Step 2: Verify the build passes**

```bash
cd mobile && npm run build
```

Expected: build completes with no errors. Note any warnings but don't fix them now.

**Step 3: Commit**

```bash
git add mobile/app/layout.tsx
git commit -m "feat(pwa): add manifest link and Apple PWA meta to layout"
```

---

## Task 4: Allow production origin in CORS

**Files:**
- Modify: `.env.example` (document the variable)
- Create: `backend/tests/test_cors.py`

The CORS config in `backend/main.py:74` already reads from the `ALLOWED_ORIGINS` env var and splits by comma. No code change needed — just update `.env.example` and add a test.

**Step 1: Write the failing test**

Create `backend/tests/test_cors.py`:

```python
import os
import pytest

# Must set env vars before any project imports
os.environ.setdefault("JWT_SECRET_KEY", "test-secret-key-that-is-long-enough-for-hs256")
os.environ.setdefault("SPARK_COACH_PASSWORD_HASH", "")
os.environ.setdefault("DATABASE_URL", "sqlite:///:memory:")
os.environ.setdefault("MCP_SERVER_URL", "http://localhost:3000")
os.environ.setdefault("MCP_API_KEY", "")
os.environ.setdefault("GEMINI_API_KEY", "fake-key")
os.environ["ALLOWED_ORIGINS"] = "http://localhost:3000,http://localhost:3001,https://coach.ziksaka.com"

from fastapi.testclient import TestClient
from main import app

client = TestClient(app)


def test_cors_allows_localhost():
    resp = client.get("/health", headers={"Origin": "http://localhost:3000"})
    assert resp.headers.get("access-control-allow-origin") == "http://localhost:3000"


def test_cors_allows_production_origin():
    resp = client.get("/health", headers={"Origin": "https://coach.ziksaka.com"})
    assert resp.headers.get("access-control-allow-origin") == "https://coach.ziksaka.com"


def test_cors_blocks_unknown_origin():
    resp = client.get("/health", headers={"Origin": "https://evil.example.com"})
    # Should not echo the unknown origin back
    assert resp.headers.get("access-control-allow-origin") != "https://evil.example.com"
```

**Step 2: Run tests to verify they fail**

```bash
cd backend && python -m pytest tests/test_cors.py -v
```

Expected: `test_cors_allows_production_origin` FAILS (only `localhost:3000` is in the default origins).

**Step 3: Update `.env.example` to document the variable**

In `.env.example`, add after the existing entries:

```bash
# Allowed CORS origins (comma-separated). Add your production domain here.
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:3001,https://coach.ziksaka.com
```

**Step 4: Update local `.env` to match**

In `.env` (not committed), add or update:

```bash
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:3001,https://coach.ziksaka.com
```

**Step 5: Restart the backend and run tests**

```bash
cd backend && python -m pytest tests/test_cors.py -v
```

Expected: all 3 tests PASS.

**Step 6: Run the full test suite to check for regressions**

```bash
cd backend && python -m pytest -v
```

Expected: all tests pass.

**Step 7: Commit**

```bash
git add .env.example backend/tests/test_cors.py
git commit -m "feat(cors): allow coach.ziksaka.com as production origin"
```

---

## Task 5: Create deploy configuration files

**Files:**
- Create: `deploy/nginx-api.conf`
- Create: `deploy/deploy.sh`

**Step 1: Create the Nginx config**

Create `deploy/nginx-api.conf`:

```nginx
# Nginx reverse proxy config for coach-api.ziksaka.com
# Copy to: /etc/nginx/sites-available/coach-api
# Enable with: ln -s /etc/nginx/sites-available/coach-api /etc/nginx/sites-enabled/
# Then: certbot --nginx -d coach-api.ziksaka.com

server {
    listen 80;
    server_name coach-api.ziksaka.com;

    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts for long-running LLM requests
        proxy_read_timeout 120s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 120s;
    }
}
```

**Step 2: Create the deploy script**

Create `deploy/deploy.sh`:

```bash
#!/usr/bin/env bash
# deploy.sh — Idempotent first-time VPS setup for Spark Coach API
# Run as root (or with sudo) on the VPS.
# Usage: bash deploy.sh
set -euo pipefail

REPO_URL="https://github.com/YOUR_USERNAME/spark-coach.git"  # UPDATE THIS
INSTALL_DIR="/opt/spark-coach"

echo "=== Spark Coach VPS Setup ==="

# ── 1. System dependencies ──────────────────────────────────────────────────
echo "[1/7] Installing system dependencies..."
apt-get update -qq
apt-get install -y -qq docker.io docker-compose-v2 nginx certbot python3-certbot-nginx git curl

systemctl enable --now docker
systemctl enable --now nginx

# ── 2. Clone repo ────────────────────────────────────────────────────────────
echo "[2/7] Cloning repository to $INSTALL_DIR..."
if [ -d "$INSTALL_DIR/.git" ]; then
    echo "  Repo exists — pulling latest..."
    git -C "$INSTALL_DIR" pull
else
    git clone "$REPO_URL" "$INSTALL_DIR"
fi

cd "$INSTALL_DIR"

# ── 3. .env file ─────────────────────────────────────────────────────────────
echo "[3/7] Checking .env file..."
if [ ! -f ".env" ]; then
    echo ""
    echo "  ERROR: .env file not found at $INSTALL_DIR/.env"
    echo "  Copy .env.example to .env and fill in your secrets:"
    echo ""
    echo "    cp .env.example .env && nano .env"
    echo ""
    echo "  Required variables:"
    echo "    JWT_SECRET_KEY       — random string (openssl rand -hex 32)"
    echo "    SPARK_COACH_PASSWORD_HASH — bcrypt hash of your login password"
    echo "    GEMINI_API_KEY       — your Gemini API key"
    echo "    MCP_SERVER_URL       — https://mcp.ziksaka.com/mcp"
    echo "    ALLOWED_ORIGINS      — https://coach.ziksaka.com"
    echo ""
    exit 1
fi
echo "  .env found."

# ── 4. Start API container ────────────────────────────────────────────────────
echo "[4/7] Starting API container..."
docker compose up -d --build
echo "  Waiting for API to be ready..."
sleep 5
curl -sf http://localhost:8080/health > /dev/null && echo "  API is up." || (echo "  ERROR: API health check failed. Check: docker compose logs" && exit 1)

# ── 5. Configure Nginx ────────────────────────────────────────────────────────
echo "[5/7] Configuring Nginx..."
cp deploy/nginx-api.conf /etc/nginx/sites-available/coach-api
ln -sf /etc/nginx/sites-available/coach-api /etc/nginx/sites-enabled/coach-api
nginx -t && systemctl reload nginx
echo "  Nginx configured."

# ── 6. SSL with Certbot ───────────────────────────────────────────────────────
echo "[6/7] Provisioning SSL..."
certbot --nginx -d coach-api.ziksaka.com --non-interactive --agree-tos -m YOUR_EMAIL
systemctl reload nginx
echo "  SSL provisioned."

# ── 7. Final verification ─────────────────────────────────────────────────────
echo "[7/7] Verifying deployment..."
sleep 2
HTTP_STATUS=$(curl -sf -o /dev/null -w "%{http_code}" https://coach-api.ziksaka.com/health || echo "000")
if [ "$HTTP_STATUS" = "200" ]; then
    echo "  SUCCESS: https://coach-api.ziksaka.com/health returned 200"
else
    echo "  WARNING: Health check returned $HTTP_STATUS (DNS may still be propagating)"
fi

echo ""
echo "=== Setup complete ==="
echo "API:    https://coach-api.ziksaka.com"
echo "Health: https://coach-api.ziksaka.com/health"
```

**Step 3: Verify bash syntax**

```bash
bash -n deploy/deploy.sh && echo "Syntax OK"
```

Expected: `Syntax OK`

**Step 4: Make executable and commit**

```bash
chmod +x deploy/deploy.sh
git add deploy/
git commit -m "feat(deploy): add Nginx config and VPS setup script for coach-api.ziksaka.com"
```

---

## Task 6: VPS deployment (execute on server)

> These are manual steps to run on the VPS via SSH. Not scripted here.

**Prerequisites (do these before running deploy.sh):**
1. Add DNS A record: `coach-api.ziksaka.com` → VPS IP (at your DNS provider)
2. Wait for DNS propagation: `dig coach-api.ziksaka.com` should resolve to VPS IP

**Run the deploy script:**

```bash
# From your local machine
scp .env user@YOUR_VPS_IP:/opt/spark-coach/.env  # copy secrets first
ssh user@YOUR_VPS_IP
sudo bash /opt/spark-coach/deploy/deploy.sh
```

**Update `deploy.sh` before running:**
- Replace `YOUR_USERNAME` in `REPO_URL` with your GitHub username
- Replace `YOUR_EMAIL` in the certbot line with your email

**Verify:**

```bash
curl https://coach-api.ziksaka.com/health
# Expected: {"status": "ok", "app": "SPARK Coach", ...}

curl -X POST https://coach-api.ziksaka.com/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"password": "YOUR_PASSWORD"}'
# Expected: {"access_token": "...", "token_type": "bearer"}
```

---

## Task 7: Vercel deployment (manual steps in browser)

> These are one-time steps in the Vercel dashboard.

**Prerequisites:**
- Push all commits to GitHub main branch
- Have a Vercel account (free at vercel.com)

**Steps:**

1. Go to vercel.com → New Project → Import your GitHub repo
2. Set **Root Directory** to `mobile` (critical — the app is not at the repo root)
3. Framework: auto-detected as Next.js
4. Add environment variable:
   - Key: `NEXT_PUBLIC_API_URL`
   - Value: `https://coach-api.ziksaka.com`
5. Click Deploy — wait ~2 minutes
6. Go to Project Settings → Domains → Add `coach.ziksaka.com`
7. At your DNS provider, add CNAME record: `coach` → `cname.vercel-dns.com`
8. Vercel provisions SSL automatically (1–2 minutes after DNS propagates)

**Verify:**

- Open `https://coach.ziksaka.com` in browser → redirects to `/login` ✓
- Log in with your password → lands on Home screen ✓
- Home screen shows live briefing from API ✓

**Install as PWA on phone:**

Android (Chrome):
1. Open `https://coach.ziksaka.com` in Chrome
2. Tap menu (⋮) → "Add to Home screen"
3. Tap "Add"

iOS (Safari):
1. Open `https://coach.ziksaka.com` in Safari
2. Tap Share (□↑) → "Add to Home Screen"
3. Tap "Add"

---

## Verification Checklist

Run through these after completing all tasks:

```bash
# Backend
curl https://coach-api.ziksaka.com/health
# → {"status": "ok", ...}

# CORS header (simulates browser request from production frontend)
curl -H "Origin: https://coach.ziksaka.com" https://coach-api.ziksaka.com/health -v 2>&1 | grep -i "access-control"
# → access-control-allow-origin: https://coach.ziksaka.com

# Frontend
curl -I https://coach.ziksaka.com
# → HTTP/2 200

# PWA manifest accessible
curl https://coach.ziksaka.com/manifest.json | python3 -m json.tool
# → valid JSON with name, icons, display fields
```

**Phone test:**
- [ ] `coach.ziksaka.com` loads on phone
- [ ] Login works
- [ ] Home screen shows live greeting + today's focus
- [ ] "Add to Home Screen" installs the PWA
- [ ] Installed app opens fullscreen with no browser chrome

---

## Commit Log (expected)

```
feat(pwa): add placeholder icons for PWA install
feat(pwa): add PWA manifest for Rafiki
feat(pwa): add manifest link and Apple PWA meta to layout
feat(cors): allow coach.ziksaka.com as production origin
feat(deploy): add Nginx config and VPS setup script for coach-api.ziksaka.com
```
